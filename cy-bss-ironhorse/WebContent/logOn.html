<!DOCTYPE html>
<html>
<head>
	<meta charset="ISO-8859-1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Iron Horse - LogOn</title>
	
	<link rel="stylesheet" href="css/bootstrap/3.2.0/bootstrap.min.css">
	<script src="js/jquery/1.11.3/jquery.min.js"></script>
	<script src="js/bootstrap/3.3.4/bootstrap.min.js"></script> 
	<script src="js/angularjs/1.3.15/angular.min.js"></script>   
	<script src="js/angular-translate/2.8.1/angular-translate.min.js"></script>
	
	<script src="js/ironhorse-common.js"></script>
	
</head>
<body>
<div class="container-fluid" ng-app="logonApp" ng-controller="logonCtrl">
	<div class="page-header" ng-include="'includes/header.html'"></div>
	<div class="well well-sm"><span>Logon</span></div>

	<form novalidate name="logon" id="logon" class="form-horizontal" role="form" method="post">
		<div class="form-group">
			<label class="col-sm-1 control-label">User Id</label>
			<div class="col-sm-4">
				<input class="form-control" name="userId" id="userId" type="text" ng-model="userId" required/>
				<span class="help-block" ng-show="logon.userId.$error.required" translate>USER_ID.REQUIRED</span>
      		</div>
      	</div>
      	<div class="form-group">
			<label class="col-sm-1 control-label">Password</label>
			<div class="col-sm-4">
				<input class="form-control" name="pwd" id="pwd" type="password" ng-model="pwd" required/>
				<span class="help-block" ng-show="logon.pwd.$error.required" translate>PWD.REQUIRED</span>
      		</div>
		</div>
		
		<div class="form-group" ng-show="errorMessage">
	    <label class="col-sm-1 control-label">Error</label>
	    <div class="col-sm-9">
	    	<div class="alert alert-danger">
          		{{ errorMessage }}
        	</div>
		</div>
		</div>
		
		<button type="button" class="btn btn-default" ng-click="onSubmit()" translate>SUBMIT.BUTTON</button>
		<button type="button" class="btn btn-default" ng-click="onReset()" translate>RESET.BUTTON</button>
	
		
	</form>	


</div>

<script>
       var app=angular.module('logonApp', ['pascalprecht.translate'])
			.config(function($translateProvider) {
			// Our translations will go in here
			$translateProvider
			.translations('en',{
				'SUBMIT.BUTTON':'Submit',
    		    'RESET.BUTTON': 'Reset',
    		    'USER_ID.REQUIRED': 'User Id is required.',
    		    'PWD.REQUIRED': 'Password is required.'	 
			})
			 
			.translations('it',{
				 'SUBMIT.BUTTON':'Conferma',
	    		 'RESET.BUTTON': 'Reset',
	    		 'USER_ID.REQUIRED': 'User Id è obbigatoria.',
	    		 'PWD.REQUIRED': 'Password è obbligatoria.'		
			});
			
		   $translateProvider.preferredLanguage(getLanguage());
			 
	 	});
		
       	app.controller('logonCtrl', function($scope, $http,$translate) {
    	$scope.coreUrl=getLocalStorageItem("org.cysoft.bss.ih.coreurl");
    	   
	    $scope.onSubmit = function() {
	    		$scope.errorMessage="";
	    		
	    		if (!$scope.logon.$valid)
	    			return;
	    		
	    		
	    		callRestWs($http,'cybss-auth/logOn','POST',
	    				'"Security-Token": "'+$scope.securityToken+'"',
	    				'"userId":"'+$scope.userId+'","pwd":"'+$scope.pwd+'"',
	    				function(response){
	   						if (response.data.resultCode==RESULT_OK){
	   							
	   							setLocalStorageItem("org.cysoft.bss.ih.securityToken", response.data.securityToken);
	   							setLocalStorageItem("org.cysoft.bss.ih.user.id", response.data.user.id);
	   							setLocalStorageItem("org.cysoft.bss.ih.user.userId", response.data.user.userId);
	   							setLocalStorageItem("org.cysoft.bss.ih.user.roleId", response.data.user.roleId);
	   							setLocalStorageItem("org.cysoft.bss.ih.user.role", response.data.user.role);
	   							setLocalStorageItem("org.cysoft.bss.ih.user.languageId", response.data.user.languageId);
	   							setLocalStorageItem("org.cysoft.bss.ih.user.languageCode", response.data.user.languageCode);
	   	       			 		
	   							$("#logon").attr("action","index.html");
	   	       		 			$("#logon").submit();
	   						}
	   						else
	   						{
	   							manageError($scope,response.data.resultCode,response.data.resultDesc);
	   						}
	   					}, 
	   					function(response){
	   							manageError($scope,response.status,response.data);
	   					});
	    		
    		}
    	 
		$scope.onReset = function() {
    		$scope.userId="";
    		$scope.pwd="";
    		$scope.errorMessage="";
    	}
		
       });   
       
       function manageError($scope,status,data){
       		$scope.errorMessage=status+" - "+data;	
       }
       
       setLocalStorageItem("org.cysoft.bss.ih.user.role", "undefined");
	   setMenuCntl(app);
      

</script>

</body>
</html>